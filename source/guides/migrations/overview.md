---
title: Руководство - Миграции
---

# Миграции

Миграции позволяют изменять структуру базы данных посредством Ruby.
Они работают в связке с [инструментами командной строки](/guides/command-line/database), которые вносят описанные изменения в базу данных и [генерируют](/guides/command-line/generators) файлы миграций.

Миграции доступны только для реляционных баз данных с нашим [SQL адаптером](/guides/models/overview).

## Структура миграций

Миграции являются обычными файлами Ruby и по умолчанию хранятся в `db/migrations`.
Имя миграции состоит из временной метки UTC и имени, состоящего из маленьких букв, с нижним подчеркиванием в качестве разделителя (например, `db/migrations/20150621165604_create_books.rb`).

```ruby
Hanami::Model.migration do
  change do
    create_table :books do
      primary_key :id
      foreign_key :author_id, :authors, on_delete: :cascade, null: false

      column :code,  String,  null: false, unique: true, size: 128
      column :title, String,  null: false
      column :price, Integer, null: false, default: 100 # cents

      check { price > 0 }
    end
  end
end
```

В блоке `create_table` определена структура таблицы.

Первая строка содержит `primary_key :id`, что является сокращением для целочисленного столбца с автоинкрементацией.

Далее идет объявление внешнего ключа с каскадным ограничением ссылочной целостности.
Первым аргументом задается столбец из объявляемой таблицы (`books.author_id`), а вторым название внешней таблицы.

Следующие три строки задают столбцы.
В качестве первого аргумента в `#column` передается имя столбца, а в качестве второго его тип.
Задать тип можно при помощи стандартного **типа Ruby**, такого как `String` или `Integer`, или строкой с **встроенным типом базы данных**(например, `"varchar(32)"` или `"text[]"`).

Последним необязательным аргументом является хэш, который определяет дополнительные свойства столбца. Например: допустимость NULL значений, поддержка уникальности значений, размер или значения по умолчанию.

В последней строке указано органичение на столбец price. База данных всегда будет проверять, чтобы его значения были больше нуля.

## Вверх/вниз

Миграции могут проходить в двух направлениях. Когда мы используем команду "migrate", база данных будет двигаться _"вверх"_.
Если же мы захотим откатить изменения, то база данных вернется к более ранней версии(направление _"вниз"_).

Выполняя в файле миграций блок `change` мы неявно делаем шаг _"вверх"_.
Обратную же операцию _"вниз"_ `Hanami::Model` выполняет автоматически во время отмены миграции.

Представим, что у нас есть подобный код:

```ruby
Hanami::Model.migration do
  change do
    create_table :books do
      # ...
    end
  end
end
```

Для операции `create_table`, Hanami::Model будет использовать `drop_table` чтобы отменить изменения.

Также можно сделать изменения сразу в обоих направлениях в одном файле миграции. Для этого необходимо использовать блоки `up` и `down`.

```ruby
Hanami::Model.migration do
  up do
    create_table :books do
      # ...
    end
  end

  down do
    drop_table :books
  end
end
```

**Инструменты командной строки подробно описаны в [этом разделе](/guides/command-line/database).**

## Ссылки

Hanami::Model использует [Sequel](http://sequel.jeremyevans.net/) в качестве движка миграций баз данных. Для получения более подробной информации о миграциях обратитесь к [документации Sequel](http://sequel.jeremyevans.net/rdoc/files/doc/schema_modification_rdoc.html).
