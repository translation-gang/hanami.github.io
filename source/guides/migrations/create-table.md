---
title: Руководство - Миграции: Создание таблиц
---

# Миграции

## Создание таблиц

Таблицы создаются методом `#create_table`. Он принимает два аргумента: **название таблицы** и **блок**, в котором описана структура таблицы.

У этого метода есть безопасный аналог `#create_table?`. Он создаст таблицу только в том случае, если ее еще не существует.
Также есть принудительный аналог `#create_table!`. Если таблица с заданным названием уже существует, то он удалит ее и создаст новую.

**Мы не рекомендуем использовать последние два метода в файлах миграций**.

#### Объявление столбцов

Для объявления столбцов внутри блока `#create_table` используется метод `#column`. Ему передается **имя столбца**, **тип данных** и **набор опций**.
Имя столбца должны быть уникальным в пределах таблицы.

В качестве типа можно передать тип данных Руби(например `String`), символ с названием типа данных Руби(например `:string`) или строку с типом данных встроенным в базу данных(например `"varchar(255)"`).

##### Типы данных

Поддерживаются следующие типы данных Руби:

  * `String` (`varchar(255)`)
  * `Numeric` (`numeric`)
  * `Fixnum` (`integer`)
  * `Integer` (`integer`)
  * `Bignum` (`bigint`)
  * `Float` (`double precision`)
  * `BigDecimal` (`numeric`)
  * `Date` (`date`)
  * `DateTime` (`timestamp`)
  * `Time` (`timestamp`)
  * `TrueClass` (`boolean`)
  * `FalseClass` (`boolean`)
  * `File` (`blob`)

В зависимости от базы данных это соответствие может незначительно отличаться.

##### Опции

Поддерживаются следующие опции:

  * `:default` (задает значение по умолчанию);
  * `:index` (помечает поле как индекс);
  * `:null` (разрешает или запрещает значение NULL);
  * `:primary_key` (помечает поле как первичный ключ);
  * `:unique` (включает поддержку уникальности значений);



#### Первичный ключ

Мы можем объявить **первичный ключ** используя следующий синтаксис:

```ruby
column :id, Integer, null: false, primary_key: true
# или используя такое сокращение
primary_key :id
```

#### Внешний ключ

**Внешние ключи** объявляются через метод `#foreign_key`, которому передается **имя поля** в текущей таблице, **имя внешней таблицы** и **набор опций**.

В следующем примере будет создано поле `author_id`(integer) в таблице `books`, помеченное как внешний ключ.

```ruby
create_table :books do
  # ...
  foreign_key :author_id, :authors, on_delete: :cascade, null: false
end
```

##### Опции

Этот метод принимает следующий набор опций:

  * `:deferrable` (допускает задержку во время транзакций);
  * `:key` (поле в ассоциированной таблице, которому соответствует внешний ключ. Избыточно, если это поле является первичным ключом);
  * `:null` (разрешены ли NULL значения);
  * `:type` (тип данных поля);
  * `:on_delete` (действие после удаления записи во внешней таблице: `:restrict`, `:cascade`, `:set_null` или `:set_default`);
  * `:on_update` (действие после изменения записи во внешней таблице: `:restrict`, `:cascade`, `:set_null` или `:set_default`).


#### Индексы

Индексы объявляются через метод `#index`. Он принимает **имя** одного или нескольких полей и **набор опций**.

```ruby
create_table :stores do
  # ...
  column :code, Integer, null: false
  column :lat, Float
  column :lng, Float

  index :code, unique: true
  index [:lat, :lng], name: :stores_coords_index
end
```

##### Опции

Этот метод принимает следующий набор опций:

  * `:unique` (проверка уникальности);
  * `:name` (выбор нестандартного имени);
  * `:type` (тип индекса, если поддерживается базой данных);
  * `:where` (часть индекса, если поддерживается базой данных)


#### Ограничение

Мы можем задать ограничения на значения полей методом `#constraint`. Он принимает **имя поля** и **блок**.

```ruby
create_table :users do
  # ...
  column :age, Integer
  constraint(:adult_constraint) { age > 18 }
end
```

Обратите внимание, блок исполняется движком базы данных. **Сложный код Руби не будет работать**.

Функции баз данных имеют аналоги в виде функций Руби, но это может слишком усложнить код миграций.

```ruby
create_table :users do
  # ...
  column :password, String
  constraint(:password_length_constraint) { char_length(password) >= 8 }
end
```

#### Проверки

Проверки похожи на ограничения, но они принимают только **анонимный блок** или **строку чистого SQL**.

```ruby
create_table :users do
  # ...
  column :age, Integer
  column :role, String

  check { age > 18 }
  check %(role IN("contributor", "manager", "owner"))
end
```
