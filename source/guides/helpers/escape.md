---
title: Руководство - Хэлперы экранирования разметки
---

## Хэлперы экранирования разметки

**Представления автоматически экранируют результат вызова всех методов.**
Есть ряд случаев, когда представления не могут справиться должным образом самостоятельно. Эти случаи требуют от нас особого внимания.

Ханами поставляется с набором экранирующих хэлперов, которые позволяют сделать веб-приложения более защищенными.
Они доступны в качестве **открытых методов**, доступных в шаблонах и представлениях.

## Экранирование содержимого тэгов HTML

Метод`#escape_html` (или синоним`#h`) экранирует переданную строку.

```erb
<p><%= h "<script>alert('xss')</script>" %></p>
```
 
Вернет:

```html
<p>&lt;script&gt;alert(&apos;xss&apos;)&lt;&#x2F;script&gt;</p>
```

## Экранирование атрибутов HTML

HTML атрибуты более сложны для экранирования, они содержат ограничительные символы(двойные или одинарные кавычки).

Для этого создан специальный хэлпер: `#escape_html_attribute` (или синоним`#ha`)
**Его стоит применять только там, где источником данных может быть пользователь**

```erb
<img="/path/to/avatar.png" title="<%= ha(user.name) %>'s Avatar">
```

## Белый список URL

Представим, что у нас в приложении есть возможность, позволяющая пользователям делиться ссылками на свой сайт.
Во время редактирования профиля пользователь может заполнить простое текстовое поле, в котором будет содержаться URL.

Тогда страница профиля будет содержать эту ссылку примерно так:

```erb
<%= link_to "Website", user.website_url %>
```

Это позволит злоумышленнику вставить код JavaScript в качестве URL.
Когда кто-то кликнет по такой ссылке, он станем жертвой XSS атаки.

Пример:

```html
<a href="javascript:alert('hack!');">Website</a>
```

Решением этой проблемы является обертка вокруг выводимого поля при помощи хэлпера `#escape_url` (или синоним`#hu`).

Он будет пропускать URL соответствующие схемам `http`, `https` и`mailto`. Все остальное не будет пропущено.

```erb
<%= link_to "Website", hu(user.website_url) %>
```

Если нам нужно несколько видов таких схем, то мы можем явно указать это во втором аргументе.

```erb
<%= link_to "Website", hu(user.website_url, ['https']) %>
```

В этом примере будут пропущены только ссылки на HTTPS.

## Неэкранированный контент

В ряде случаев мы хотим вывести неэкранированный контент.
**Используйте эту возможность с осторожностью. Это потенциальная уязвимость для XSS атаки.**

Хэлперь называется `#raw`.

```ruby
# apps/web/views/books/json_show.rb
require 'json'

module Web::Views::Books
  class JsonShow < Show
    format :json

    def render
      raw JSON.generate(book.to_h)
    end
  end
end
```
